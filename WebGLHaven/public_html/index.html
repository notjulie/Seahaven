<!DOCTYPE html>
<html>
   <head>
      <link rel="stylesheet" href="style.css" type="text/css"/>

      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
      <title>WebGLHaven</title>
   </head>

   <body id="body">
      <canvas id="c"></canvas>

      <!-- beautiful three.js -->
      <script type="text/javascript" src="three/three.js"></script>
      <script src="three/GLTFLoader.js"></script>

      <!-- WebHaven js includes -->
      <script type="text/javascript" src="Card3D.js"></script>
      <script type="text/javascript" src="DeckOfCards.js"></script>
      <script type="text/javascript" src="GameState.js"></script>
      <script type="text/javascript" src="Renderer.js"></script>
      <script type="text/javascript" src="Shapes.js"></script>
      <script type="text/javascript" src="World.js"></script>


      <!-- Three.js WebGL main rendering loop -->
      <script type="text/javascript">
         // create our world geometry
         var world = new World();

         var deckOfCards = new DeckOfCards({
            width: world.getCardWidth(),
            height: (0.7 / 0.43) * world.getCardWidth(),
            cornerRadius: world.getCardWidth() / 10,
            rankHeight: (0.13 / 0.43) * world.getCardWidth()
         });

         var gameState = new GameState();

         function resizeCanvas() {
            renderer.resizeCanvas(body.clientWidth, body.clientHeight);
         }

         function main() {

            // create our renderer
            const canvas = document.querySelector('#c');
            var renderer = new Renderer(canvas);
            var scene = renderer.getScene();

            // add our handler to resize it
            body.onresize = function () {
               renderer.resizeCanvas(body.clientWidth, body.clientHeight);
            };
            body.onresize();

            var groundGeometry = new THREE.PlaneGeometry(1000, 1000);
            groundGeometry.rotateX(-90 * Math.PI / 180);
            var ground = new THREE.Mesh(groundGeometry, new THREE.MeshMatcapMaterial({color: 0x7f4f00}));
            ground.position.y = world.getGroundY();
            scene.add(ground);

            var tableWorldGeometry = world.getTableGeometry();
            var tableWorldSize = tableWorldGeometry.getSize(new THREE.Vector3());
            var tableGeometry = new THREE.PlaneGeometry(
                    tableWorldSize.x,
                    Math.sqrt(tableWorldSize.y * tableWorldSize.y + tableWorldSize.z * tableWorldSize.z)
                    );
            tableGeometry.computeBoundingBox();
            tableGeometry.translate(0, -tableGeometry.boundingBox.min.y, 0);
            tableGeometry.rotateX(-Math.atan2(tableWorldSize.z, tableWorldSize.y));
            var table = new THREE.Mesh(tableGeometry, new THREE.MeshMatcapMaterial({color: 0x007F00}));
            table.position.y = tableWorldGeometry.min.y;
            table.position.z = tableWorldGeometry.max.z;
            scene.add(table);


            // initialize our deck of cards; on completion add cards to the scene
            deckOfCards.initialize(function () {
               // build an array of all cards
               var allCards = new Array();
               for (var suit = 0; suit < 4; ++suit) {
                  for (var rank = 1; rank <= 13; ++rank) {
                     var card = deckOfCards.createCard3D(suit, rank);
                     scene.add(card);
                     allCards[allCards.length] = card;
                  }
               }

               // have the card positioner put them somewhere
               for (var column = 0; column < 10; ++column) {
                  for (row = 0; row < 5; ++row) {
                     var position = world.getColumnPosition(column, row);
                     var card = allCards[5 * column + row];
                     card.position.x = position.x;
                     card.position.y = position.y;
                     card.position.z = position.z;
                  }
               }

               // and put the last two on towers
               var position = world.getTowerTop(1);
               allCards[50].position.x = position.x - world.getCardWidth() / 2;
               allCards[50].position.y = position.y;
               allCards[50].position.z = position.z;
               position = world.getTowerTop(2);
               allCards[51].position.x = position.x - world.getCardWidth() / 2;
               allCards[51].position.y = position.y;
               allCards[51].position.z = position.z;
            });


            var towers = new Array();
            var loader = new THREE.GLTFLoader();

            loader.load('tower/scene.gltf', function (gltf) {
               var tower = gltf.scene;
               tower.scale.x = tower.scale.y = tower.scale.z = world.getTowerScale();
               tower.add(new THREE.SpotLight(0xFFFFFF, 4));

               for (var i = 0; i < 4; ++i) {
                  towers[i] = tower.clone();
                  var position = world.getTowerPosition(i);
                  towers[i].position.x = position.x;
                  towers[i].position.y = position.y;
                  towers[i].position.z = position.z;
                  scene.add(towers[i]);
               }
            }, undefined, function (error) {
               console.error(error);
            });

            renderer.start();

         }

         main();
      </script>
   </body>
</html>
